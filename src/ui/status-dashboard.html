<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Status</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #1a1d23;
            --bg-card: #1c1f26;
            --text-primary: #ffffff;
            --text-secondary: #9ca3af;
            --accent: #3b82f6;
            --safe: #10b981;
            --risky: #f59e0b;
            --danger: #ef4444;
            --border: #2d313a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            font-size: 12px;
            overflow: hidden;
            -webkit-app-region: drag;
        }

        .container {
            padding: 12px;
            padding-bottom: 16px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }

        .header h1 {
            font-size: 14px;
            font-weight: 600;
        }

        .health-score {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .health-score .score {
            font-size: 16px;
            font-weight: 700;
            color: var(--safe);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            max-height: 320px;
            overflow-y: auto;
            -webkit-app-region: no-drag;
        }

        /* Dark scrollbar styling */
        .stats-grid::-webkit-scrollbar {
            width: 6px;
        }

        .stats-grid::-webkit-scrollbar-track {
            background: var(--bg-card);
            border-radius: 3px;
        }

        .stats-grid::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 3px;
        }

        .stats-grid::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .stat-card {
            background: var(--bg-card);
            border-radius: 6px;
            padding: 8px;
            -webkit-app-region: no-drag;
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 14px;
            font-weight: 700;
        }

        .stat-bar {
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 6px;
        }

        .stat-bar-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.3s, background 0.3s;
        }

        .stat-bar-fill.low {
            background: var(--safe);
        }

        .stat-bar-fill.medium {
            background: var(--risky);
        }

        .stat-bar-fill.high {
            background: var(--danger);
        }

        .stat-details {
            font-size: 10px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .wide-card {
            grid-column: span 2;
        }

        .processes-list {
            margin-top: 6px;
        }

        .process-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            font-size: 11px;
        }

        .process-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .process-cpu {
            color: var(--risky);
            font-weight: 600;
            min-width: 40px;
            text-align: right;
        }

        .schedule-section {
            background: var(--bg-card);
            border-radius: 8px;
            padding: 10px;
            margin-top: 8px;
            border-left: 3px solid var(--accent);
        }

        .schedule-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .schedule-icon {
            font-size: 14px;
        }

        .schedule-text {
            font-weight: 600;
            font-size: 12px;
        }

        .schedule-details {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: var(--text-secondary);
        }

        .footer {
            margin-top: 10px;
            padding-top: 8px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 6px;
        }

        .action-btn {
            -webkit-app-region: no-drag;
            flex: 1;
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border);
            padding: 8px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: var(--border);
        }

        .action-btn.primary {
            background: var(--accent);
            border-color: var(--accent);
        }

        .action-btn.primary:hover {
            background: #2563eb;
        }

        .action-btn.danger {
            color: var(--danger);
            border-color: var(--danger);
        }

        .action-btn.danger:hover {
            background: var(--danger);
            color: white;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>System Status</h1>
            <div class="health-score">
                <span class="score" id="health-score">--</span>
                <span style="color: var(--text-secondary); font-size: 11px;">Health</span>
            </div>
        </div>

        <div class="stats-grid">
            <!-- CPU -->
            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-label">CPU</span>
                </div>
                <div class="stat-value" id="cpu-usage">--%</div>
                <div class="stat-bar">
                    <div class="stat-bar-fill low" id="cpu-bar" style="width: 0%"></div>
                </div>
                <div class="stat-details" id="cpu-details">Loading...</div>
            </div>

            <!-- Memory -->
            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-label">Memory</span>
                </div>
                <div class="stat-value" id="memory-usage">--%</div>
                <div class="stat-bar">
                    <div class="stat-bar-fill low" id="memory-bar" style="width: 0%"></div>
                </div>
                <div class="stat-details" id="memory-details">Loading...</div>
            </div>

            <!-- Macintosh HD (boot disk) -->
            <div class="stat-card" id="boot-disk-card">
                <div class="stat-header">
                    <span class="stat-label">Macintosh HD</span>
                </div>
                <div class="stat-value" id="boot-disk-value">--%</div>
                <div class="stat-bar">
                    <div class="stat-bar-fill low" id="boot-disk-bar" style="width: 0%"></div>
                </div>
                <div class="stat-details" id="boot-disk-details">Loading...</div>
            </div>

            <!-- Network -->
            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-label">Network</span>
                </div>
                <div class="stat-value" id="network-speed">--</div>
                <div class="stat-details" id="network-details">‚Üì -- ‚Üë --</div>
            </div>

            <!-- Uptime -->
            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-label">Uptime</span>
                </div>
                <div class="stat-value" id="uptime-value">--</div>
                <div class="stat-details">System uptime</div>
            </div>

            <!-- External Disks (dynamically populated - can be 0 or more) -->
            <div id="external-disks-container">
                <div class="stat-card">
                    <div class="stat-header">
                        <span class="stat-label">External Disk</span>
                    </div>
                    <div class="stat-value">--</div>
                    <div class="stat-details">No disk connected</div>
                </div>
            </div>

            <!-- Top Processes -->
            <div class="stat-card wide-card">
                <div class="stat-header">
                    <span class="stat-label">Top Processes (CPU)</span>
                </div>
                <div class="processes-list" id="processes-list">
                    <div class="process-item">
                        <span class="process-name">Loading...</span>
                        <span class="process-cpu">--%</span>
                    </div>
                </div>
            </div>

            <!-- Transfer Status -->
            <div class="stat-card wide-card" id="transfer-status-card" style="display: none;">
                <div class="stat-header">
                    <span class="stat-label">Transfer Status</span>
                </div>

                <!-- Sharing Section -->
                <div id="transfer-sharing-section" style="display: none; margin-bottom: 8px;">
                    <div class="stat-label" style="font-size: 9px; margin-bottom: 4px; color: var(--accent);">üì§ Sharing
                    </div>
                    <div class="processes-list" id="transfer-sharing-list"></div>
                </div>

                <!-- Receiving Section -->
                <div id="transfer-receiving-section" style="display: none;">
                    <div class="stat-label" style="font-size: 9px; margin-bottom: 4px; color: var(--safe);">üì• Receiving
                    </div>
                    <div class="processes-list" id="transfer-receiving-list"></div>
                </div>
            </div>
        </div>

        <!-- Schedule Section -->
        <div class="schedule-section" id="schedule-section" style="display: none;">
            <div class="schedule-header">
                <span class="schedule-icon">üìÖ</span>
                <span class="schedule-text" id="schedule-text">--</span>
            </div>
            <div class="schedule-details">
                <span id="schedule-categories"></span>
                <span id="schedule-countdown"></span>
            </div>
        </div>

        <div class="footer">
            <button class="action-btn primary" onclick="openMainApp()">Open MacCleaner</button>
            <button class="action-btn" onclick="runClean()">Run Clean</button>
            <button class="action-btn danger" onclick="quitApp()">Quit</button>
        </div>
    </div>

    <script>
        // Format bytes
        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1000; // macOS uses base 10
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        // Get bar class based on percentage
        function getBarClass(percent) {
            if (percent < 50) return 'low';
            if (percent < 80) return 'medium';
            return 'high';
        }

        // Update stats
        async function updateStats() {
            try {
                const stats = await window.statusAPI.getSystemStats();

                // CPU
                document.getElementById('cpu-usage').textContent = stats.cpu.usage + '%';
                document.getElementById('cpu-bar').style.width = stats.cpu.usage + '%';
                document.getElementById('cpu-bar').className = 'stat-bar-fill ' + getBarClass(stats.cpu.usage);
                document.getElementById('cpu-details').textContent = stats.cpu.model || 'Unknown CPU';

                // Memory
                const memPercent = Math.round((stats.memory.used / stats.memory.total) * 100);
                document.getElementById('memory-usage').textContent = memPercent + '%';
                document.getElementById('memory-bar').style.width = memPercent + '%';
                document.getElementById('memory-bar').className = 'stat-bar-fill ' + getBarClass(memPercent);
                document.getElementById('memory-details').textContent =
                    formatBytes(stats.memory.used) + ' / ' + formatBytes(stats.memory.total);

                // Boot Disk (Macintosh HD)
                if (stats.disks && stats.disks.length > 0) {
                    const bootDisk = stats.disks[0];
                    const freePercent = bootDisk.freePercent || 0;
                    const barClass = freePercent > 50 ? 'low' : freePercent > 20 ? 'medium' : 'high';
                    document.getElementById('boot-disk-value').textContent = freePercent + '% free';
                    document.getElementById('boot-disk-bar').style.width = (100 - freePercent) + '%';
                    document.getElementById('boot-disk-bar').className = 'stat-bar-fill ' + barClass;
                    document.getElementById('boot-disk-details').textContent = formatBytes(bootDisk.free) + ' free of ' + formatBytes(bootDisk.total);
                }

                // External Disks (ALL of them, dynamically)
                const externalDisks = stats.disks ? stats.disks.slice(1) : [];
                const extContainer = document.getElementById('external-disks-container');

                if (externalDisks.length > 0) {
                    extContainer.innerHTML = externalDisks.map(disk => {
                        const freePercent = disk.freePercent || 0;
                        const barClass = freePercent > 50 ? 'low' : freePercent > 20 ? 'medium' : 'high';
                        return `
                            <div class="stat-card">
                                <div class="stat-header">
                                    <span class="stat-label">${disk.name}</span>
                                </div>
                                <div class="stat-value">${freePercent}% free</div>
                                <div class="stat-bar">
                                    <div class="stat-bar-fill ${barClass}" style="width: ${100 - freePercent}%"></div>
                                </div>
                                <div class="stat-details">${formatBytes(disk.free)} free of ${formatBytes(disk.total)}</div>
                            </div>
                        `;
                    }).join('');
                } else {
                    extContainer.innerHTML = `
                        <div class="stat-card">
                            <div class="stat-header">
                                <span class="stat-label">External Disk</span>
                            </div>
                            <div class="stat-value">--</div>
                            <div class="stat-details">No disk connected</div>
                        </div>
                    `;
                }

                // Network
                document.getElementById('network-speed').textContent =
                    formatBytes(stats.network.rx + stats.network.tx) + '/s';
                document.getElementById('network-details').textContent =
                    '‚Üì ' + formatBytes(stats.network.rx) + '/s  ‚Üë ' + formatBytes(stats.network.tx) + '/s';

                // Top Processes
                const processList = document.getElementById('processes-list');
                if (stats.processes && stats.processes.length > 0) {
                    processList.innerHTML = stats.processes.slice(0, 3).map(p => `
                        <div class="process-item">
                            <span class="process-name">${p.name}</span>
                            <span class="process-cpu">${p.cpu}%</span>
                        </div>
                    `).join('');
                }

                // Uptime
                document.getElementById('uptime-value').textContent = stats.uptime || '--';

                // Health Score (simple calculation)
                const diskUsedPercent = stats.disks && stats.disks[0] ? (100 - stats.disks[0].freePercent) : 0;
                const avgUsage = (stats.cpu.usage + memPercent + diskUsedPercent) / 3;
                const health = Math.round(100 - avgUsage);
                const healthEl = document.getElementById('health-score');
                healthEl.textContent = health;
                healthEl.style.color = health > 70 ? 'var(--safe)' : health > 40 ? 'var(--risky)' : 'var(--danger)';

            } catch (err) {
                console.error('Error updating stats:', err);
            }
        }

        // Update Transfer Status
        async function updateTransferStatus() {
            try {
                if (!window.statusAPI.getTransferStatus) return;

                const status = await window.statusAPI.getTransferStatus();
                const container = document.getElementById('transfer-status-card');
                const sharingSection = document.getElementById('transfer-sharing-section');
                const receivingSection = document.getElementById('transfer-receiving-section');
                const sharingList = document.getElementById('transfer-sharing-list');
                const receivingList = document.getElementById('transfer-receiving-list');

                const hasSharing = status.sharing && status.sharing.length > 0;
                const hasReceiving = status.receiving && status.receiving.length > 0;

                // Show/Hide Main Container - Hide ONLY if BOTH are empty
                if (!hasSharing && !hasReceiving) {
                    container.style.display = 'none';
                    return;
                }
                container.style.display = 'block';

                // Render Sharing
                if (hasSharing) {
                    sharingSection.style.display = 'block';
                    sharingList.innerHTML = status.sharing.map(item => `
                        <div class="process-item">
                            <span class="process-name">üìÑ ${item.displayName}</span>
                            <span class="process-cpu" style="color: var(--accent); min-width: auto; font-size: 10px;">
                                ${item.receiverCount} transferring
                            </span>
                        </div>
                    `).join('');
                    // Enable scroll if lots of items
                    if (status.sharing.length > 4) {
                        sharingList.style.maxHeight = '100px';
                        sharingList.style.overflowY = 'auto';
                    } else {
                        sharingList.style.maxHeight = 'none';
                    }
                } else {
                    sharingSection.style.display = 'none';
                }

                // Render Receiving
                if (hasReceiving) {
                    receivingSection.style.display = 'block';
                    receivingList.innerHTML = status.receiving.map(item => `
                        <div style="margin-bottom: 6px;">
                            <div class="process-item" style="padding: 0; margin-bottom: 2px;">
                                <span class="process-name">üìÑ ${item.filename}</span>
                                <span style="font-size: 10px; color: var(--safe);">${Math.round(item.progress)}%</span>
                            </div>
                            <div class="stat-bar" style="margin-top: 2px;">
                                <div class="stat-bar-fill low" style="width: ${item.progress}%"></div>
                            </div>
                        </div>
                    `).join('');
                    // Enable scroll
                    if (status.receiving.length > 4) {
                        receivingList.style.maxHeight = '100px';
                        receivingList.style.overflowY = 'auto';
                    } else {
                        receivingList.style.maxHeight = 'none';
                    }
                } else {
                    receivingSection.style.display = 'none';
                }

            } catch (err) {
                console.error('Error updating transfer status:', err);
                document.getElementById('transfer-status-card').style.display = 'none';
            }
        }

        // Update schedule info
        async function updateSchedule() {
            try {
                const info = await window.statusAPI.getScheduleInfo();
                const section = document.getElementById('schedule-section');

                if (info.enabled) {
                    section.style.display = 'block';
                    document.getElementById('schedule-text').textContent = info.scheduleText;
                    document.getElementById('schedule-categories').textContent = info.categoryText || '';
                    document.getElementById('schedule-countdown').textContent = info.isCleaning ? 'üßπ Cleaning...' : ('‚è± ' + info.countdownText);
                } else {
                    section.style.display = 'none';
                }
            } catch (err) {
                document.getElementById('schedule-section').style.display = 'none';
            }
        }

        // Open main app
        function openMainApp() {
            window.statusAPI.openMainWindow();
        }

        // Run clean
        function runClean() {
            window.statusAPI.runClean();
        }

        // Quit app
        function quitApp() {
            window.statusAPI.quitApp();
        }

        // Initial update and interval
        updateStats();
        updateSchedule();
        updateTransferStatus();
        setInterval(updateStats, 2000);
        setInterval(updateSchedule, 5000);
        setInterval(updateTransferStatus, 2000); // Check transfer every 2s
    </script>
</body>

</html>